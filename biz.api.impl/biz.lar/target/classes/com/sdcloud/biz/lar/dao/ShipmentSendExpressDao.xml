<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sdcloud.biz.lar.dao.ShipmentSendExpressDao">
    <sql id="column">
		a.id AS "id",
		a.qr_code AS "qrCode",
		a.order_no AS "orderNo",
		a.biz_type AS "bizType",
		a.order_time AS "orderTime",
		a.order_state AS "orderState",
		a.org AS "org",
		a.area AS "area",
		a.source AS "source",
		a.customer_id AS "customerId",
		a.address_id AS "addressId",
		a.goods_type AS "goodsType",
		a.goods_weight AS "goodsWeight",
		a.express_company AS "expressCompany",
		a.pay_way AS "payWay",
		a.schedule_date AS "scheduleDate",
		a.schedule_time AS "scheduleTime",
		a.coupon AS "coupon",
		a.remark_text AS "remarkText",
		a.sales_man AS "salesMan",
		a.take_time AS "takeTime",
		a.distribute_time AS "distributeTime",
		a.finish_time AS "finishTime",
		a.cancel_time AS "cancelTime",
		a.fact_weight_one AS "factWeightOne",
		a.province_one AS "provinceOne",
		a.pay_way_one AS "payWayOne",
		a.save_money_one AS "saveMoneyOne",
		a.money_one AS "moneyOne",
		a.to_pay_one AS "toPayOne",
		a.express_company_one AS "expressCompanyOne",
		a.way_bill_no AS "wayBillNo",
		a.remarks_one AS "remarksOne",
		a.create_user AS "createUser",
		a.create_date AS "createDate",
		a.update_user AS "updateUser",
		a.update_date AS "updateDate",
		a.cancel_user AS "cancelUser",
		a.cancel_reason AS "cancelReason",
		a.take_user AS "takeUser",
		a.distribute_user AS "distributeUser",
		a.task_explain AS "taskExplain",
		a.province AS "province",
		a.evaluate AS "evaluate",
		a.turn_order_time AS "turnOrderTime",
		a.turn_order_type AS "turnOrderType",
		a.turn_order_user AS "turnOrderUser",
		a.previous_sales_man AS "previousSalesMan",
		a.account_time AS "accountTime",
		a.server_time AS "serverTime",
		a.time_type AS "timeType",
		a.cancel_take_time AS "cancelTakeTime",
		a.cancel_take_reason AS "cancelTakeReason",
		a.cancel_take_user AS "cancelTakeUser",
		a.cancel_distribute_time AS "cancelDistributeTime",
		a.cancel_distribute_user AS "cancelDistributeUser",
		a.cancel_distribute_reason AS "cancelDistributeReason",
		a.finish_user AS "finishUser",
		a.turn_order_remarks AS "turnOrderRemarks",
		a.finish_remarks as "finishRemarks",
        a.balance as "balance",
		a.account_state as "accountState",
		a.account_user as "accountUser",
		a.account_remarks as "accountRemarks",
        b.name as "areaName",
        c.userName as "userName",
        c.contact as "contact",
        c.address as "address",
        c.detail as "detail",
        d.name as "salesManName",
        e.name as "previousSalesManName",
        w.regionName as "provinceName",
        vc.name as "voucherName",
        v.amount as "voucherMoney",
        a.grab_order as "grabOrder",
        a.grab_order_time as "grabOrderTime",
        a.area_list as "areaList",
        a.grab_order_min as "grabOrderMin"
	</sql>

    <sql id="join">
        left join lar_shipmentArea b on a.area=b.id
        left join lar_address c on c.id=a.address_id
        left join lar_operation d on d.id=a.sales_man
        left join lar_operation e on e.id=a.previous_sales_man
        left join lar_region w on w.regionId =a.province
        left join lar_voucher v on v.id=a.coupon
        left join lar_voucher_condition vc on vc.id=v.condition
    </sql>

    <select id="findAll" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            1=1
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>
        </where>
        <choose>
            <when test="larPager.orderBy != null and larPager.order!=null">
                order by ${larPager.orderSql}
            </when>
            <otherwise>
                order by a.update_date desc,a.create_date desc
            </otherwise>
        </choose>
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>
    <insert id="save">
		insert into lar_send_express (
            id,
			qr_code,
			order_no,
			biz_type,
			order_time,
			order_state,
			org,
			area,
			source,
			customer_id,
			address_id,
			goods_type,
			goods_weight,
			express_company,
			pay_way,
			schedule_date,
			schedule_time,
			coupon,
			remark_text,
			sales_man,
			take_time,
			distribute_time,
			finish_time,
			cancel_time,
			fact_weight_one,
			province_one,
			pay_way_one,
			save_money_one,
			money_one,
			to_pay_one,
			express_company_one,
			way_bill_no,
			remarks_one,
			create_user,
			create_date,
			update_user,
			update_date,
			cancel_user,
			cancel_reason,
			take_user,
			distribute_user,
			task_explain,
			province,
			evaluate,
			turn_order_time,
			turn_order_type,
			turn_order_user,
			previous_sales_man,
			account_time,
			server_time,
			time_type,
			cancel_take_time,
			cancel_take_reason,
			cancel_take_user,
			cancel_distribute_time,
			cancel_distribute_user,
			cancel_distribute_reason,
			finish_user,
			finish_remarks,
			balance,
			account_state,
			account_user,
			account_remarks,
			turn_order_remarks,
			grab_order,
			grab_order_time,
			area_list,
			grab_order_min
		) VALUES (
			#{id},
			#{qrCode},
			#{orderNo},
			#{bizType},
			#{orderTime},
			#{orderState},
			#{org},
			#{area},
			#{source},
			#{customerId},
			#{addressId},
			#{goodsType},
			#{goodsWeight},
			#{expressCompany},
			#{payWay},
			#{scheduleDate},
			#{scheduleTime},
			#{coupon},
			#{remarkText},
			#{salesMan},
			#{takeTime},
			#{distributeTime},
			#{finishTime},
			#{cancelTime},
			#{factWeightOne},
			#{provinceOne},
			#{payWayOne},
			#{saveMoneyOne},
			#{moneyOne},
			#{toPayOne},
			#{expressCompanyOne},
			#{wayBillNo},
			#{remarksOne},
			#{createUser},
			#{createDate},
			#{updateUser},
			#{updateDate},
			#{cancelUser},
			#{cancelReason},
			#{takeUser},
			#{distributeUser},
			#{taskExplain},
			#{province},
			#{evaluate},
			#{turnOrderTime},
			#{turnOrderType},
			#{turnOrderUser},
			#{previousSalesMan},
			#{accountTime},
			#{serverTime},
			#{timeType},
			#{cancelTakeTime},
			#{cancelTakeReason},
			#{cancelTakeUser},
			#{cancelDistributeTime},
			#{cancelDistributeUser},
			#{cancelDistributeReason},
			#{finishUser},
            #{finishRemarks},
            #{balance},
			#{accountState},
			#{accountUser},
			#{accountRemarks},
			#{turnOrderRemarks},
			#{grabOrder},
			#{grabOrderTime},
			#{areaList},
			#{grabOrderMin}
		)
	</insert>
    <update id="update">
        update lar_send_express
        <set>
            <if test="grabOrderTime!=null and grabOrderTime!=''">
                grab_order_time = #{grabOrderTime},
            </if>
            <if test="qrCode!=null and qrCode!=''">
                qr_code = #{qrCode},
            </if>
            <if test="orderNo!=null and orderNo!=''">
                order_no = #{orderNo},
            </if>
            <if test="bizType!=null and bizType!=''">
                biz_type = #{bizType},
            </if>
            <if test="orderTime!=null and orderTime!=''">
                order_time = #{orderTime},
            </if>
            <if test="orderState!=null and orderState!=''">
                order_state = #{orderState},
            </if>
            <if test="org!=null and org!=''">
                org = #{org},
            </if>
            <if test="area!=null and area!=''">
                area = #{area},
            </if>
            <if test="source!=null and source!=''">
                source = #{source},
            </if>
            <if test="customerId!=null and customerId!=''">
                customer_id = #{customerId},
            </if>
            <if test="addressId!=null and addressId!=''">
                address_id = #{addressId},
            </if>
            <if test="goodsType!=null and goodsType!=''">
                goods_type = #{goodsType},
            </if>
            <if test="goodsWeight!=null and goodsWeight!=''">
                goods_weight = #{goodsWeight},
            </if>
            <if test="expressCompany!=null and expressCompany!=''">
                express_company = #{expressCompany},
            </if>
            <if test="payWay!=null and payWay!=''">
                pay_way = #{payWay},
            </if>
            <if test="scheduleDate!=null and scheduleDate!=''">
                schedule_date = #{scheduleDate},
            </if>
            <if test="scheduleTime!=null and scheduleTime!=''">
                schedule_time = #{scheduleTime},
            </if>
            <if test="coupon!=null and coupon!=''">
                coupon = #{coupon},
            </if>
            <if test="remarkText!=null and remarkText!=''">
                remark_text = #{remarkText},
            </if>
            <if test="salesMan!=null and salesMan!=''">
                sales_man = #{salesMan},
            </if>
            <if test="takeTime!=null and takeTime!=''">
                take_time = #{takeTime},
            </if>
            <if test="distributeTime!=null and distributeTime!=''">
                distribute_time = #{distributeTime},
            </if>
            <if test="finishTime!=null and finishTime!=''">
                finish_time = #{finishTime},
            </if>
            <if test="cancelTime!=null and cancelTime!=''">
                cancel_time = #{cancelTime},
            </if>
            <if test="factWeightOne!=null and factWeightOne!=''">
                fact_weight_one = #{factWeightOne},
            </if>
            <if test="provinceOne!=null and provinceOne!=''">
                province_one = #{provinceOne},
            </if>
            <if test="payWayOne!=null and payWayOne!=''">
                pay_way_one = #{payWayOne},
            </if>
            <if test="saveMoneyOne!=null and saveMoneyOne!=''">
                save_money_one = #{saveMoneyOne},
            </if>
            <if test="moneyOne!=null and moneyOne!=''">
                money_one = #{moneyOne},
            </if>
            <if test="toPayOne!=null and toPayOne!=''">
                to_pay_one = #{toPayOne},
            </if>
            <if test="expressCompanyOne!=null and expressCompanyOne!=''">
                express_company_one = #{expressCompanyOne},
            </if>
            <if test="wayBillNo!=null and wayBillNo!=''">
                way_bill_no = #{wayBillNo},
            </if>
            <if test="remarksOne!=null and remarksOne!=''">
                remarks_one = #{remarksOne},
            </if>
            <if test="createUser!=null and createUser!=''">
                create_user = #{createUser},
            </if>
            <if test="updateUser!=null and updateUser!=''">
                update_user = #{updateUser},
            </if>
            <if test="updateDate!=null and updateDate!=''">
                update_date = #{updateDate},
            </if>
            <if test="cancelUser!=null and cancelUser!=''">
                cancel_user = #{cancelUser},
            </if>
            <if test="cancelReason!=null and cancelReason!=''">
                cancel_reason = #{cancelReason},
            </if>
            <if test="takeUser!=null and takeUser!=''">
                take_user = #{takeUser},
            </if>
            <if test="distributeUser!=null and distributeUser!=''">
                distribute_user = #{distributeUser},
            </if>
            <if test="taskExplain!=null and taskExplain!=''">
                task_explain = #{taskExplain},
            </if>
            <if test="province!=null and province!=''">
                province = #{province},
            </if>
            <if test="evaluate!=null and evaluate!=''">
                evaluate = #{evaluate},
            </if>
            <if test="turnOrderTime!=null and turnOrderTime!=''">
                turn_order_time = #{turnOrderTime},
            </if>
            <if test="turnOrderType!=null and turnOrderType!=''">
                turn_order_type = #{turnOrderType},
            </if>
            <if test="turnOrderUser!=null and turnOrderUser!=''">
                turn_order_user = #{turnOrderUser},
            </if>
            <if test="previousSalesMan!=null and previousSalesMan!=''">
                previous_sales_man = #{previousSalesMan},
            </if>
            <if test="accountTime!=null and accountTime!=''">
                account_time = #{accountTime},
            </if>
            <if test="serverTime!=null and serverTime!=''">
                server_time = #{serverTime},
            </if>
            <if test="timeType!=null and timeType!=''">
                time_type = #{timeType},
            </if>
            <if test="cancelTakeTime!=null and cancelTakeTime!=''">
                cancel_take_time = #{cancelTakeTime},
            </if>
            <if test="cancelTakeReason!=null and cancelTakeReason!=''">
                cancel_take_reason = #{cancelTakeReason},
            </if>
            <if test="cancelTakeUser!=null and cancelTakeUser!=''">
                cancel_take_user = #{cancelTakeUser},
            </if>
            <if test="cancelDistributeTime!=null and cancelDistributeTime!=''">
                cancel_distribute_time = #{cancelDistributeTime},
            </if>
            <if test="cancelDistributeUser!=null and cancelDistributeUser!=''">
                cancel_distribute_user = #{cancelDistributeUser},
            </if>
            <if test="cancelDistributeReason!=null and cancelDistributeReason!=''">
                cancel_distribute_reason = #{cancelDistributeReason},
            </if>
            <if test="finishUser!=null and finishUser!=''">
                finish_user = #{finishUser},
            </if>
            <if test="finishRemarks!=null and finishRemarks!=''">
                finish_remarks = #{finishRemarks},
            </if>
            <if test="balance!=null and balance!=''">
                balance = #{balance},
            </if>
            <if test="accountState!=null and accountState!=''">
                account_state = #{accountState},
            </if>
            <if test="accountUser!=null and accountUser!=''">
                account_user = #{accountUser},
            </if>
            <if test="accountRemarks!=null and accountRemarks!=''">
                account_remarks = #{accountRemarks},
            </if>
            <if test="turnOrderRemarks!=null and turnOrderRemarks!=''">
                turn_order_remarks = #{turnOrderRemarks},
            </if>
            <if test="grabOrder!=null and grabOrder!=''">
                grab_order = #{grabOrder}
            </if>
        </set>
        <where>
            id=#{id}
        </where>
    </update>
    <delete id="delete">
		delete from lar_send_express where id=#{id}
	</delete>
    <select id="totalCount" resultType="java.lang.Long">
        select count(id) from lar_send_express a
        <where>
            1=1
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>
        </where>
    </select>
    <select id="countByOrgIds" resultType="java.lang.Long">
        select count(id) from lar_send_express a
        <where>
            1=1
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>
            <if test="larPager.extendList!=null and larPager.extendList.size()>0">
                <foreach collection="larPager.extendList" item="item">
                    <if test="item.key=='order_start_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='order_end_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='take_start_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='take_end_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='distribute_start_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='distribute_end_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='order_no' and item.value!=null and item.value!=''">
                        and a.order_no = #{item.value}
                    </if>
                    <if test="item.key=='area' and item.value!=null and item.value!=''">
                        and a.area = #{item.value}
                    </if>
                    <if test="item.key=='evaluate' and item.value!=null and item.value!=''">
                        and a.evaluate = #{item.value}
                    </if>
                    <if test="item.key=='order_state' and item.value!=null and item.value!=''">
                        and a.order_state = #{item.value}
                    </if>
                    <if test="item.key=='sales_man' and item.value!=null and item.value!=''">
                        and a.sales_man = #{item.value}
                    </if>
                    <if test="item.key=='time_type' and item.value!=null and item.value!=''">
                        and a.time_type = #{item.value}
                    </if>
                    <if test="item.key=='biz_type' and item.value!=null and item.value!=''">
                        and a.biz_type = #{item.value}
                    </if>
                    <if test="item.key=='account_state' and item.value=='已完'">
                        and a.account_state = '已完'
                    </if>
                    <if test="item.key=='account_state' and item.value=='未完'">
                        and (a.account_state = '未完' or a.account_state is null)
                    </if>
                    <if test="item.key=='account_user' and item.value!=null and item.value!=''">
                        and a.account_user = #{item.value}
                    </if>
                    <if test="item.key=='account_start_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[>=]]>   DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='account_end_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[<]]>   DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                </foreach>
            </if>
            <if test="ids !=null and ids.size() >0">
                and a.org in
                <foreach collection="ids" item="id" close=")" open="(" separator=",">
                    ${id}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getById" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            a.id=#{id}
            <if test="map!=null and map.size()>0">
                <foreach collection="map.keys" item="item" index="key">
                    and a.${item}=#{map[${item}]}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getByNo" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            a.order_no=#{orderNo}
        </where>
    </select>
    <select id="orderDetail" resultType="com.sdcloud.api.lar.entity.OrderDetailDTO">
        select
        a.id AS "id",
        a.order_no AS "orderNo",
        a.biz_type AS "bizType",
        a.order_state AS "orderState",
        a.address_id AS "sender",
        c.userName as "senderUserName",
        c.contact as "senderContact",
        concat(c.address,c.detail ) as "senderAddress",
        a.schedule_date AS "scheduleDate",
        a.schedule_time AS "scheduleTime",
        a.task_explain as "taskExplain",
        a.finish_remarks as "finishRemarks",
        a.coupon AS "coupon",
        a.goods_type AS "goodsType",
        a.goods_weight AS "goodsWeight",
        a.express_company AS "expressCompany",
        a.express_company_one AS "expressCompanyOne",
        v.amount as "voucherMoney",
        a.remark_text AS "remarkText",
        a.distribute_time AS "distributeTime",
        a.distribute_user AS "distributeUser",
        a.sales_man AS "salesMan",
        d.name as "salesManName",
        a.province as "province",
        w.regionName as "provinceName",
        a.way_bill_no as "wayBillNo",
        a.remarks_one as "remarksOne",
        a.save_money_one as "saveMoneyOne",
        a.fact_weight_one as "factWeight",
        a.to_pay_one as "toPayOne",
        a.money_one as "moneyOne",
        a.order_time as "orderTime",
        a.org as "org",
        a.pay_way as "payWay",
        a.evaluate as "evaluate",
        a.finish_time as "finishTime"
        from lar_send_express a
        left join lar_address c on c.id=a.address_id
        left join lar_operation d on d.id=a.sales_man
        left join lar_voucher v on v.id=a.coupon
        left join lar_region w on w.regionId =a.province
        <where>
            a.order_no=#{id}
            <if test="map!=null and map.size()>0">
                <foreach collection="map.keys" item="item" index="key">
                    and a.${item}=#{map[${item}]}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getEvaluation" resultType="com.sdcloud.api.lar.entity.OrderDetailDTO">
        SELECT
        a.evaluate AS "evaluate"
        FROM
        lar_send_express a
        <where>
            a.evaluate IS NOT NULL
            AND a.order_state = '已完成'
            AND a.sales_man = #{id}
        </where>
    </select>
    <select id="findByOrgIds" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            1=1
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>

            <if test="larPager.extendList!=null and larPager.extendList.size()>0">
                <foreach collection="larPager.extendList" item="item">
                    <if test="item.key=='order_start_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='order_end_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='take_start_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='take_end_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='distribute_start_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='distribute_end_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='order_no' and item.value!=null and item.value!=''">
                        and a.order_no = #{item.value}
                    </if>
                    <if test="item.key=='area' and item.value!=null and item.value!=''">
                        and a.area = #{item.value}
                    </if>
                    <if test="item.key=='evaluate' and item.value!=null and item.value!=''">
                        and a.evaluate = #{item.value}
                    </if>
                    <if test="item.key=='order_state' and item.value!=null and item.value!=''">
                        and a.order_state = #{item.value}
                    </if>
                    <if test="item.key=='sales_man' and item.value!=null and item.value!=''">
                        and a.sales_man = #{item.value}
                    </if>
                    <if test="item.key=='time_type' and item.value!=null and item.value!=''">
                        and a.time_type = #{item.value}
                    </if>
                    <if test="item.key=='biz_type' and item.value!=null and item.value!=''">
                        and a.biz_type = #{item.value}
                    </if>
                    <if test="item.key=='account_state' and item.value=='已完'">
                        and a.account_state = '已完'
                    </if>
                    <if test="item.key=='account_state' and item.value=='未完'">
                        and (a.account_state = '未完' or a.account_state is null)
                    </if>
                    <if test="item.key=='account_user' and item.value!=null and item.value!=''">
                        and a.account_user = #{item.value}
                    </if>
                    <if test="item.key=='account_start_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[>=]]>   DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                    <if test="item.key=='account_end_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[<]]>  DATE_FORMAT(#{item.value}, '%Y-%m-%d %T')
                    </if>
                </foreach>
            </if>
            <if test="ids !=null and ids.size() >0">
                and a.org in
                <foreach collection="ids" item="id" close=")" open="(" separator=",">
                    ${id}
                </foreach>
            </if>
        </where>
        <choose>
            <when test="larPager.orderBy != null and larPager.order!=null">
                order by ${larPager.orderSql}
            </when>
            <otherwise>
                order by a.order_time desc,a.create_date desc
            </otherwise>
        </choose>
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>
    <select id="findByOrgIdsOne" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            ((a.order_state='等待接单' and a.grab_order=10) or
            (a.order_state='等待接单' and a.grab_order=22) or
            (a.order_state='等待接单' and a.grab_order=33))
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>

            <if test="larPager.extendList!=null and larPager.extendList.size()>0">
                <foreach collection="larPager.extendList" item="item">
                    <if test="item.key=='order_start_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='order_end_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='take_start_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='take_end_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='distribute_start_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='distribute_end_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='order_no' and item.value!=null and item.value!=''">
                        and a.order_no = #{item.value}
                    </if>
                    <if test="item.key=='area' and item.value!=null and item.value!=''">
                        and a.area = #{item.value}
                    </if>
                    <if test="item.key=='evaluate' and item.value!=null and item.value!=''">
                        and a.evaluate = #{item.value}
                    </if>
                    <if test="item.key=='order_state' and item.value!=null and item.value!=''">
                        and a.order_state = #{item.value}
                    </if>
                    <if test="item.key=='sales_man' and item.value!=null and item.value!=''">
                        and a.sales_man = #{item.value}
                    </if>
                    <if test="item.key=='time_type' and item.value!=null and item.value!=''">
                        and a.time_type = #{item.value}
                    </if>
                    <if test="item.key=='biz_type' and item.value!=null and item.value!=''">
                        and a.biz_type = #{item.value}
                    </if>
                    <if test="item.key=='account_state' and item.value!=null and item.value!=''">
                        and a.account_state = #{item.value}
                    </if>
                    <if test="item.key=='account_user' and item.value!=null and item.value!=''">
                        and a.account_user = #{item.value}
                    </if>
                    <if test="item.key=='account_start_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[>=]]>   DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='account_end_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[<]]>  DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                </foreach>
            </if>
            <if test="ids !=null and ids.size() >0">
                and a.org in
                <foreach collection="ids" item="id" close=")" open="(" separator=",">
                    ${id}
                </foreach>
            </if>
        </where>
        <choose>
            <when test="larPager.orderBy != null and larPager.order!=null">
                order by ${larPager.orderSql}
            </when>
            <otherwise>
                order by a.update_date desc,a.create_date desc
            </otherwise>
        </choose>
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>
    <select id="countByOrgIdsOne" resultType="java.lang.Long">
        select count(id) from lar_send_express a
        <where>
            ((a.order_state='等待接单' and a.grab_order=10) or
            (a.order_state='等待接单' and a.grab_order=22) or
            (a.order_state='等待接单' and a.grab_order=33))
            <if test="larPager.params!=null ">
                <foreach collection="larPager.params.keys" item="item" index="key">
                    and a.${item}=#{larPager.params[${item}]}
                </foreach>
            </if>

            <if test="larPager.extendList!=null and larPager.extendList.size()>0">
                <foreach collection="larPager.extendList" item="item">
                    <if test="item.key=='order_start_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='order_end_time' and item.value!=null and item.value!=''">
                        and a.order_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='take_start_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='take_end_time' and item.value!=null and item.value!=''">
                        and a.take_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='distribute_start_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[>=]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='distribute_end_time' and item.value!=null and item.value!=''">
                        and a.distribute_time <![CDATA[<]]> DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='order_no' and item.value!=null and item.value!=''">
                        and a.order_no = #{item.value}
                    </if>
                    <if test="item.key=='area' and item.value!=null and item.value!=''">
                        and a.area = #{item.value}
                    </if>
                    <if test="item.key=='evaluate' and item.value!=null and item.value!=''">
                        and a.evaluate = #{item.value}
                    </if>
                    <if test="item.key=='order_state' and item.value!=null and item.value!=''">
                        and a.order_state = #{item.value}
                    </if>
                    <if test="item.key=='sales_man' and item.value!=null and item.value!=''">
                        and a.sales_man = #{item.value}
                    </if>
                    <if test="item.key=='time_type' and item.value!=null and item.value!=''">
                        and a.time_type = #{item.value}
                    </if>
                    <if test="item.key=='biz_type' and item.value!=null and item.value!=''">
                        and a.biz_type = #{item.value}
                    </if>
                    <if test="item.key=='account_state' and item.value!=null and item.value!=''">
                        and a.account_state = #{item.value}
                    </if>
                    <if test="item.key=='account_user' and item.value!=null and item.value!=''">
                        and a.account_user = #{item.value}
                    </if>
                    <if test="item.key=='account_start_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[>=]]>   DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                    <if test="item.key=='account_end_time' and item.value!=null and item.value!=''">
                        and a.account_time <![CDATA[<]]>  DATE_FORMAT(#{item.value}, '%Y-%m-%d')
                    </if>
                </foreach>
            </if>
            <if test="ids !=null and ids.size() >0">
                and a.org in
                <foreach collection="ids" item="id" close=")" open="(" separator=",">
                    ${id}
                </foreach>
            </if>
        </where>
    </select>
    <update id="updateState">
        update lar_send_express
        <set>
            <foreach collection="params.keys" item="item" index="key" separator=",">
                ${item}=#{params[${item}]}
            </foreach>
        </set>
        where id IN
        <foreach collection="ids" item="id" close=")" open="(" separator=",">
            #{id}
        </foreach>
    </update>
    
    <update id="updateGrab">
     update lar_send_express
        set
        <foreach collection="result.keys" item="item" index="key" separator=",">
            ${item}=#{result[${item}]}
        </foreach>
        where id IN
        <foreach collection="list" item="id" close=")" open="(" separator=",">
            #{id}
        </foreach>
        
        <foreach collection="condition.keys" item="item" index="key">
            and ${item}=#{condition[${item}]}
        </foreach>
    
    </update>
    
    <select id="findByIds" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            a.id in
            <foreach collection="ids" close=")" open="(" separator="," item="id">
                #{id}
            </foreach>
        </where>
    </select>
    <select id="selectData" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        select
        <include refid="column"/>
        from lar_send_express a
        <include refid="join"/>
        <where>
            <foreach collection="list" close=")" open="(" separator="and " item="id">
                ${list.key} ${list.operation} #{list.value}
            </foreach>
        </where>
    </select>

    <select id="selectDataTotalCount" resultType="java.lang.Long">
        select
        count(1)
        from lar_send_express a
        <include refid="join"/>
        <where>
            <foreach collection="list" close=")" open="(" separator="and " item="id">
                ${list.key} ${list.operation} #{list.value}
            </foreach>
        </where>
    </select>
    <select id="getBalance" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        SELECT
        sum(a.balance) as balance,
        a.customer_id as customerId
        FROM
        lar_send_express AS a
				LEFT JOIN lar_clientuser AS c ON a.customer_id=c.customerId
        WHERE
        a.order_state = '已完成'
		and c.`enable`=0
		and balance>0
        GROUP BY
        a.customer_id
    </select>

    <select id="getCount" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
        SELECT
        count(a.id) as "count",
        a.customer_id as "customerId"
        FROM
        lar_send_express AS a
				LEFT JOIN  `lar_clientuser` b ON a.customer_id = b.customerId 
        WHERE
        a.order_state = '已完成'
        		and b.enable=0	
        GROUP BY
        a.customer_id
    </select>
    <select id="serviceListCount" resultType="java.lang.Long">
        SELECT
        sum(aa)
        FROM
        (
        (
        SELECT
        count(*) AS aa
        FROM
        lar_send_express a
        LEFT JOIN lar_operation w ON w.id = a.sales_man
        WHERE
        w.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and a.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
<!--         UNION
        (
        SELECT
        count(*) AS aa
        FROM
        lar_help_me_buy b
        LEFT JOIN lar_operation y ON y.id = b.sales_man
        WHERE
        y.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and b.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        ) -->
        UNION
        (
        SELECT
        count(*) AS aa
        FROM
        lar_city_send c
        LEFT JOIN lar_operation z ON z.id = c.sales_man
        WHERE
        z.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and c.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        )
        ) bb
    </select>
    <!-- 添加公式的设置 -->
     <resultMap type="com.sdcloud.api.lar.entity.OrderServiceDTO" id="dtoMap">
     	<result property="org" column="org"/>
     	<result property="bizType" column="bizType"/>
     	<association property="shipmentExpression" column="{org=org,bizType=bizType}" javaType="com.sdcloud.api.lar.entity.ShipmentExpression" select="findExpressionByOrg"></association>
     </resultMap>
     <select id="findExpressionByOrg" parameterType="java.util.Map" resultType="com.sdcloud.api.lar.entity.ShipmentExpression">
     	select * 
     	from
     	lar_expression
     	where #{bizType}="同城送" and type = "同城送" and org = #{org} 
     </select>
    <select id="serviceList" resultMap="dtoMap">
        select * from ((
        SELECT
        a.id AS "id",
        a.org,
        a.order_no as "orderNo",
        a.schedule_date "scheduleDate",
        a.schedule_time "scheduleTime",
        a.biz_type "bizType",
        <!-- a.take_time AS "takeTime", -->
        a.order_time AS "takeTime",
        a.goods_weight as "goodsWeight",
        a.goods_type as "goodsType",
        a.pay_way as "goodsName",
        a.server_time as "shopName",
        a.sales_man as "salesMan",
        w.name as "salesManName",
        a.customer_id as "buyType",
        v.amount as "voucherMoney",
        a.money_one as "distance",
        a.to_pay_one as "receivableService",
        ca.userName as "scheduleUserName",
        ca.contact as "schedulePhone",
        ca.address as "scheduleAddress",
        ca.detail as "scheduleDetail",
        a.express_company AS "express",
        null AS "serviceCost"
        FROM
        lar_send_express a
        LEFT JOIN lar_operation w ON w.id = a.sales_man
        left join lar_address ca on ca.id=a.address_id
        left join lar_voucher v on v.id=a.coupon
        WHERE
        w.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and a.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
<!--         UNION
        (
        SELECT
        b.id,
        b.org,
        b.order_no as "orderNo",
        b.schedule_date "scheduleDate",
        b.schedule_time "scheduleTime",
        b.biz_type "bizType",
        b.take_time,
        b.order_time AS "takeTime",
        b.distance as "goodsWeight",
        b.pay_model as "goodsType",
        b.goods_name as "goodsName",
        s.name as "shopName",
        b.sales_man as "salesMan",
        y.name as "salesManName",
        b.buy_type as "buyType",
        v.amount as "voucherMoney",
        b.distance as "distance",
        b.service_cost as "receivableService",
        cc.userName as "scheduleUserName",
        cc.contact as "schedulePhone",
        cc.address as "scheduleAddress",
        cc.detail as "scheduleDetail",
        null AS "express",
        b.service_cost AS "serviceCost"
        FROM
        lar_help_me_buy b
        LEFT JOIN lar_operation y ON y.id = b.sales_man
        left join lar_shop s on s.id=b.shop
        left join lar_voucher v on v.id=b.coupon
        left join lar_address cc on cc.id=b.receiver
        WHERE
        y.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and b.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        ) -->
        UNION
        (
        SELECT
        c.id,
        c.org,
        c.order_no as "orderNo",
        c.schedule_date "scheduleDate",
        c.schedule_time "scheduleTime",
        c.biz_type "bizType",
        <!-- c.take_time, -->
        c.order_time AS "takeTime",
        c.goods_weight as "goodsWeight",
        c.account_remarks as "goodsType",
        c.goods_name as "goodsName",
        c.server_time as "shopName",
        c.sales_man as "salesMan",
        z.name as "salesManName",
        c.customer_id,
        v.amount as "voucherMoney",
        c.distance as "distance",
        c.receivable_service as "receivableService",
        ccc.userName as "scheduleUserName",
        ccc.contact as "schedulePhone",
        ccc.address as "scheduleAddress",
        ccc.detail as "scheduleDetail",
        null AS "express",
        c.service_cost AS "serviceCost"
        FROM
        lar_city_send c
        LEFT JOIN lar_operation z ON z.id = c.sales_man
        left join lar_voucher v on v.id=c.coupon
        left join lar_address ccc on ccc.id=c.sender
        WHERE
        z.sysUser = #{userId}
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and c.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        )
        ) as aa
        ORDER BY
        aa.scheduleDate asc, aa.scheduleTime asc,aa.takeTime
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>

    <select id="serviceHistoryCount" resultType="java.lang.Long">
        SELECT
        sum(aa)
        FROM
        (
        (
        SELECT
        count(*) AS aa
        FROM
        lar_send_express a
        LEFT JOIN lar_operation w ON w.id = a.sales_man
        WHERE
        w.sysUser = #{userId}
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key">
                or a.${list.key} ${list.operation} #{list.value}
            </foreach>
        </if>
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
        <!-- UNION
        (
        SELECT
        count(*) AS aa
        FROM
        lar_help_me_buy b
        LEFT JOIN lar_operation y ON y.id = b.sales_man
        WHERE
        y.sysUser = #{userId}
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key">
                or b.${list.key} ${list.operation} #{list.value}
            </foreach>
        </if>
        ) -->
        UNION
        (
        SELECT
        count(*) AS aa
        FROM
        lar_city_send c
        LEFT JOIN lar_operation z ON z.id = c.sales_man
        WHERE
        z.sysUser = #{userId}
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key">
                or c.${list.key} ${list.operation} #{list.value}
            </foreach>
        </if>
        )
        ) bb
    </select>
    <select id="serviceHistory" resultType="com.sdcloud.api.lar.entity.OrderServiceDTO">
        select id,orderNo,scheduleDate,scheduleTime,bizType,takeTime,orderTime,
        	   goodsWeight,goodsType,goodsName,orderState,org,shop
        
        from ((
        SELECT
        a.id AS "id",
        a.order_no as "orderNo",
        a.schedule_date "scheduleDate",
        a.schedule_time "scheduleTime",
        a.biz_type "bizType",
        a.take_time AS "takeTime",
        a.order_time AS "orderTime",
        a.finish_time,
        a.goods_weight as "goodsWeight",
        a.goods_type as "goodsType",
        a.pay_way as "goodsName",
        a.order_state as "orderState",
        a.org as "org",
        a.coupon as "shop"
        FROM
        lar_send_express a
        LEFT JOIN lar_operation w ON w.id = a.sales_man
        WHERE
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key" separator="or" >
                (w.sysUser = #{userId}  and  a.${list.key} ${list.operation} #{list.value} )
            </foreach>
        </if>
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
<!--         UNION
        (
        SELECT
        b.id,
        b.order_no,
        b.schedule_date,
        b.schedule_time,
        b.biz_type,
        b.take_time,
        b.order_time,
        b.finish_time,
        b.distance,
        b.pay_model,
        b.goods_name,
        b.order_state,
        b.org,
        b.shop
        FROM
        lar_help_me_buy b
        LEFT JOIN lar_operation y ON y.id = b.sales_man
        WHERE
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key" separator="or">
                (y.sysUser = #{userId}  and  b.${list.key} ${list.operation} #{list.value} )
            </foreach>
        </if>
        ) -->
        UNION
        (
        SELECT
        c.id,
        c.order_no,
        c.schedule_date,
        c.schedule_time,
        c.biz_type,
        c.take_time,
        c.order_time,
        c.finish_time,
        c.goods_weight,
        c.account_remarks,
        c.goods_name,
        c.order_state,
        c.org,
        c.addressee
        FROM
        lar_city_send c
        LEFT JOIN lar_operation z ON z.id = c.sales_man
        WHERE
        <if test="larPager.extendList!=null and larPager.extendList.size>0 ">
            <foreach collection="larPager.extendList" item="list" index="key" separator="or">
                (z.sysUser = #{userId} and c.${list.key} ${list.operation} #{list.value})
            </foreach>
        </if>
        )
        ) as aa
        ORDER BY
        aa.finish_time DESC
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>

    <select id="grabOrderListCount" resultType="java.lang.Long">
        SELECT
        sum(aa)
        FROM
        (
        (
        SELECT
        count(*) AS aa
        FROM
        lar_send_express a
        WHERE
        a.order_state='等待接单'
        
        and a.`grab_order`=31 
        
        <if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
        
         <if test="null !=larPager.params and null !=larPager.params.org">
        	and a.org = #{larPager.params.org}
        </if>
        <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and a.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
        <!-- <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and a.${item}=#{larPager.params[${item}]}
            </foreach>
        </if> -->
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
        <!-- UNION ALL
        (
        SELECT
        count(*) AS aa
        FROM
        lar_help_me_buy b
        WHERE
        b.order_state='等待接单'
        and b.`grab_order`=31 
        <if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
        
         <if test="null !=larPager.params and null !=larPager.params.org">
        	and b.org = #{larPager.params.org}
        </if>
        <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and b.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and b.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        ) -->
        
        UNION ALL
        (
        SELECT
        count(*) AS aa
        FROM
        lar_city_send c
        WHERE
        c.order_state='等待接单'
        and c.`grab_order`=31 
        
        <if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
         <if test="null !=larPager.params and null !=larPager.params.org">
        	and c.org = #{larPager.params.org}
        </if>
        <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and c.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
       <!--  <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and c.${item}=#{larPager.params[${item}]}
            </foreach>
        </if> -->
        
        )
        UNION ALL
        (
        SELECT
        count(*) AS aa
        FROM
        lar_ordermanager d 
        WHERE d.orderStatusName='等待接单'
        and d.`grab_order`=31 
         <if test="null !=larPager.params and null !=larPager.params.recovery and 0 == larPager.params.recovery">
        	and 1=0
        </if>
        
         <if test="null !=larPager.params and null !=larPager.params.areaSettingId and larPager.params.areaSettingId.size>0">
        	and d.areaSettingId in  
        	<foreach collection="larPager.params.areaSettingId" item="item" close=")" open="(" separator=",">
                    ${item.id}
        </foreach>
        </if>
         <if test="null !=larPager.params and null !=larPager.params.areaSettings">
        	and d.area_list REGEXP #{larPager.params.areaSettings}
        
        </if>
        
       <!--  <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and d.${item}=#{larPager.params[${item}]}
            </foreach>
        </if> -->
        )
        ) bb
    </select>
    
    
    
    <select id="grabOrderList" resultType="com.sdcloud.api.lar.entity.OrderServiceDTO">
        select * from ((
        SELECT
        a.id AS "id", 
        a.order_no as "orderNo",
        a.schedule_date "scheduleDate",
        a.schedule_time "scheduleTime",
        a.biz_type "bizType",
        a.order_time AS "takeTime",
        ca.userName as "scheduleUserName",
        ca.contact as "schedulePhone",
        CONCAT(ca.address,ca.detail) as "scheduleAddress"
        FROM
        lar_send_express a
        left join lar_address ca on ca.id=a.address_id
        WHERE
        a.order_state='等待接单'
        and a.`grab_order`=31 
        <if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
        <if test="null !=larPager.params and null !=larPager.params.org">
        	and a.org = #{larPager.params.org}
        </if>
        <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and a.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
        
        <!-- <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and a.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>-->
        )
        <!--jzc 去除帮我买业务 16-11-15 -->
        <!-- UNION
        (
        SELECT
        b.id,
        b.order_no,
        b.schedule_date,
        b.schedule_time,
        b.biz_type,
        b.order_time,
        cc.userName as "scheduleUserName",
        cc.contact as "schedulePhone",
        CONCAT(cc.address,cc.detail) as "scheduleAddress"
        FROM
        lar_help_me_buy b
        left join lar_address cc on cc.id=b.receiver
        WHERE
        b.order_state='等待接单'
        and b.`grab_order`=31 
        <if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
        <if test="null !=larPager.params and null !=larPager.params.org">
        	and b.org = #{larPager.params.org}
        </if>
         <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and b.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
        <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and b.${item}=#{larPager.params[${item}]}
            </foreach>
        </if>
        ) -->
        UNION
        (
        SELECT
        c.id,
        c.order_no,
        c.schedule_date,
        c.schedule_time,
        c.biz_type,
        c.order_time,
        ccc.userName as "scheduleUserName",
        ccc.contact as "schedulePhone",
        CONCAT(ccc.address,ccc.detail) as "scheduleAddress"
        FROM
        lar_city_send c
        left join lar_address ccc on ccc.id=c.sender
        WHERE
        c.order_state='等待接单'
      	and c.`grab_order`=31 
      	<if test="null !=larPager.params and null !=larPager.params.shipmentFlag and 0 == larPager.params.shipmentFlag">
        	and 1=0
        </if>
      	
        <if test="null !=larPager.params and null !=larPager.params.org">
        	and c.org = #{larPager.params.org}
        </if>
         <if test="null !=larPager.params and null !=larPager.params.shipmentAreas">
        	and c.area_list REGEXP #{larPager.params.shipmentAreas}
        
        </if>
        <!-- <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and c.${item}=#{larPager.params[${item}]}
            </foreach>
        </if> -->
        ) 
        UNION
        (
        SELECT
        d.id,
        d.orderId,
        d.cancelOrderPersonName,
        d.maaDate AS "scheduleTime",
        d.businessTypeName,
        d.createDate,
        ddd.userName ,
        ddd.contact ,
        CONCAT(ddd.address,ddd.detail) AS "address"
        FROM
        lar_ordermanager d
        LEFT JOIN lar_address ddd ON ddd.id = d.larClientUserAddressId
        WHERE
        d.orderStatusName='等待接单' 
        and d.`grab_order`=31 
        
        <if test="null !=larPager.params and null !=larPager.params.recovery and 0 == larPager.params.recovery">
        	and 1=0
        </if>
        <if test="null !=larPager.params and null !=larPager.params.areaSettingId and larPager.params.areaSettingId.size>0">
        	and d.areaSettingId in  
        	<foreach collection="larPager.params.areaSettingId" item="item" close=")" open="(" separator=",">
                    ${item.id}
        </foreach>
        </if>
         <if test="null !=larPager.params and null !=larPager.params.areaSettings">
        	and d.area_list REGEXP #{larPager.params.areaSettings}
        
        </if>
        <!-- <if test="larPager.params!=null ">
            <foreach collection="larPager.params.keys" item="item" index="key">
                and d.${item}=#{larPager.params[${item}]}
            </foreach>
        </if> -->
        )
        ) as aa
        ORDER BY
        aa.takeTime DESC
        <if test="larPager.first!=null and larPager.pageSize!=null">
            limit #{larPager.first}, #{larPager.pageSize}
        </if>
    </select>
    <!-- 返回优惠券 -->
    <update id="backCoupon">
        UPDATE lar_send_express s,lar_voucher v 
        SET v.use_type = "可用" 
        <where>
        	 s.coupon=v.id AND
        	 s.id in 
			 <foreach collection="ids" item="id" open="(" close=")" separator=",">
			 	#{id}
			 </foreach>
        </where>
    </update>
    <!-- 自动派单 -->
    <select id="findInvalidOrder" resultType="com.sdcloud.api.lar.entity.ShipmentSendExpress">
		select 
		 orderNo,grabOrder,orderState,area,distributeUser,salesMan
		FROM
		(
			SELECT 
			s.order_no as orderNo,
			s.grab_order as grabOrder,
			s.order_State as orderState,
			o.area,o.sysUser as distributeUser,o.id as salesMan
			FROM lar_send_express s 
			LEFT JOIN lar_operation o
			ON (o.`enable` = 0 AND FIND_IN_SET(o.area,s.area_list) )
			WHERE 
			s.grab_order=31 and s.order_State='等待接单' and 
			UNIX_TIMESTAMP(s.order_time)+ ${time} &lt; UNIX_TIMESTAMP(#{date})
			ORDER BY RAND()
		) as ship
		GROUP BY orderNo
	</select>
	<update id="batchUpdate">
		update lar_send_express
		<trim prefix="set" suffixOverrides=",">
			<trim prefix=" grab_order = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.grabOrder}
               </foreach>
            </trim>
            <trim prefix=" order_State = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.orderState}
               </foreach>
            </trim>
            <trim prefix=" area = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.area}
               </foreach>
            </trim>
            <trim prefix=" distribute_user = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.distributeUser}
               </foreach>
            </trim>
            <trim prefix=" sales_man = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.salesMan}
               </foreach>
            </trim>
            <trim prefix=" distribute_time = case" suffix="end,">
               <foreach collection="list" item="i">
                   when order_no=#{i.orderNo} then #{i.distributeTime}
               </foreach>
            </trim>
		</trim>
		<where>
			order_no in 
            <foreach collection="list" open="(" close=")" item="i" separator=",">
              #{i.orderNo}
          </foreach>
		</where>
	</update>
	
	<select id="selectDisCount" resultType="int">
        SELECT
        sum(aa)
        FROM
        (
        (
        SELECT
        count(*) AS aa
        FROM
        lar_send_express a
        WHERE a.order_state='服务中'
        <if test="id !=null and id.size>0 ">
            AND sales_man in 
            <foreach item="item" index="index" collection="id" open="(" separator="," close=")">
            	#{item}
	        </foreach>
        </if>
        )
        UNION
        (
        SELECT
        count(*) AS aa
        FROM
        lar_city_send c
        WHERE c.order_State = '服务中'
        <if test="id !=null and id.size>0 ">
            AND sales_man in 
            <foreach item="item" index="index" collection="id" open="(" separator="," close=")">
            	#{item}
	        </foreach>
        </if>
        )
        ) bb
    </select>
</mapper>